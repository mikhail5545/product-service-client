name: ci.yml
on: [pull_request, push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout client repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout proto repo into proto-deps
        uses: actions/checkout@v4
        with:
          repository: mikhail5545/protos
          path: proto-deps

      - name: Install buf
        run: |
          curl -sSLf "https://github.com/bufbuild/buf/releases/latest/download/buf-$(uname | tr '[:upper:]' '[:lower:]')-x86_64" -o /usr/local/bin/buf
          chmod +x /usr/local/bin/buf
          buf --version

      - name: Generate pb to pb_tmp
        run: |
          if ! command -v buf &>/dev/null; then
            echo "install buf: https://docs.buf.build/installation"
            exit 2
          fi
          
          OUT_DIR=$(mktemp -d)
          trap 'rm -rf "${OUT_DIR}"' EXIT
          
          # buf will use buf.work which references proto-deps/proto (the proto repo checkout)
          buf generate --template buf.gen.yaml --output "${OUT_DIR}"
          
          rm -rf pb_tmp || true
          mv "${OUT_DIR}" pb_tmp
          echo "Generated pb in pb_tmp/"

      - name: Compare generated pb to pb_tmp
        run: |
          if [ -d pb ]; then
            diff -ru pb pb_tmp || (echo "pb/ is out of date. Run ./scripts/gen-proto.sh and commit changes." && exit 1)
          else
            echo "No pb/ directory committed; expected pb/ to contain generated code." && exit 1
          fi

      - name: Build and Test
        run: |
          go mod tidy
          go test ./... -v
